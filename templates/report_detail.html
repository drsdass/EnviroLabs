{% extends "base.html" %}
{% block content %}

<section class="card report-card">
    <div class="report-header">
        <h1>Report for Lab ID: <span class="mono">{{ r.lab_id | default("") }}</span></h1>
        <div class="actions">
            <a class="button" href="javascript:history.back()">Back</a>
            <button class="button primary" onclick="window.print()">Print PDF</button>
        </div>
    </div>

    <h2 class="section-title">Client Information</h2>
    <h2 class="section-title">Sample Summary</h2>
    <section class="card" style="margin: 20px 0; padding: 20px;">
        <h2 class="section-title" style="margin-top: 0;">Sample Results</h2>
        {% if r.pdf_url %}
        <table class="table clean">
            <thead>
                <tr>
                    <th>Analyte</th>
                    <th>Result</th>
                    <th>MRL</th>
                    <th>Units</th>
                    <th>Dilution</th>
                    <th>Analyzed</th>
                    <th>Qualifier</th>
                </tr>
            </thead>
            <tbody>
                {% set results = r.pdf_url.split(' | ') %}
                {% for item in results %}
                    {% set parts = item.split(': ') %}
                    {% if parts | length == 2 %}
                    <tr>
                        <td>{{ parts[0] }}</td>
                        <td>{{ parts[1] }}</td>
                        <td>{{ p.sample_results.mrl }}</td>
                        <td>{{ p.sample_results.units }}</td>
                        <td>{{ p.sample_results.dilution }}</td>
                        <td>{{ p.sample_results.analyzed }}</td>
                        <td>{{ p.sample_results.qualifier }}</td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="muted">No detailed analyte results found for this sample.</p>
        {% endif %}
    </section>


    <section class="card" style="margin: 20px 0; padding: 20px;">
        <h2 class="section-title" style="margin-top: 0;">Quality Control Results</h2>

        <h3 style="font-size: 1.1rem; margin: 15px 0 8px;">Method Blank</h3>
        {% if p.mb_structured_data %}
        <table class="table clean">
            <thead>
                <tr>
                    <th>Analyte</th>
                    <th>Result</th>
                    <th>MRL</th>
                    <th>Units</th>
                    <th>Dilution</th>
                </tr>
            </thead>
            <tbody>
                {# Loop over the list of dictionaries created in app.py #}
                {% for mb_item in p.mb_structured_data %}
                    <tr>
                        <td>{{ mb_item.analyte }}</td> 
                        <td>{{ mb_item.result }}</td> 
                        <td>{{ mb_item.mrl }}</td> 
                        <td>{{ mb_item.units }}</td> 
                        <td>{{ mb_item.dilution }}</td> 
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
             <p class="muted">Method Blank data is not available for this sample.</p>
        {% endif %}


        <h3 style="font-size: 1.1rem; margin: 15px 0 8px;">Matrix Spike</h3>
        {% if p.ms1_structured_data %}
        <table class="table clean">
            <thead>
                <tr>
                    <th>Analyte</th>
                    <th>Result</th>
                    <th>MRL</th>
                    <th>Units</th>
                    <th>Dilution</th>
                    <th>Fortified Level</th>
                    <th>%REC</th>
                    <th>%REC Limits</th>
                </tr>
            </thead>
            <tbody>
                {% for ms1_item in p.ms1_structured_data %}
                    <tr>
                        <td>{{ ms1_item.analyte }}</td> 
                        <td>{{ ms1_item.result }}</td> 
                        <td>{{ ms1_item.mrl }}</td> 
                        <td>{{ ms1_item.units }}</td> 
                        <td>{{ ms1_item.dilution }}</td> 
                        <td>{{ ms1_item.fortified_level }}</td> 
                        <td>{{ ms1_item.pct_rec }}</td> 
                        <td>{{ ms1_item.pct_rec_limits }}</td> 
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="muted">Matrix Spike data is not available for this sample.</p>
        {% endif %}

        
        <h3 style="font-size: 1.1rem; margin: 15px 0 8px;">Matrix Spike Duplicate</h3>
        <p class="muted" style="margin-bottom: 8px;">Note: This section currently displays the MSD result from the last analyzed analyte only due to database constraints.</p>
        <table class="table clean">
            <thead>
                <tr>
                    <th>Analyte</th>
                    <th>Result</th>
                    <th>Units</th>
                    <th>Dilution</th>
                    <th>%REC</th>
                    <th>%REC Limits</th>
                    <th>%RPD</th>
                    <th>%RPD Limit</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ p.matrix_spike_dup.analyte }}</td>
                    <td>{{ p.matrix_spike_dup.result }}</td>
                    <td>{{ p.matrix_spike_dup.units }}</td>
                    <td>{{ p.matrix_spike_dup.dilution }}</td>
                    <td>{{ p.matrix_spike_dup.pct_rec }}</td>
                    <td>{{ p.matrix_spike_dup.pct_rec_limits }}</td>
                    <td>{{ p.matrix_spike_dup.pct_rpd }}</td>
                    <td>{{ p.matrix_spike_dup.pct_rpd_limit }}</td>
                </tr>
            </tbody>
        </table>
    </section>

    </section>

{% endblock %}
