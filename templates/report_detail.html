{% extends "base.html" %}
{% block content %}

<section class="card report-card">

    <div class="report-brand">
        <div class="brand-left">
            <img src="{{ url_for('static', filename='logo.png') }}" class="logo" alt="Enviro Labs">
            <div class="brand-name">Enviro Labs LLC</div>
        </div>
        <div class="brand-title">Certificate of Analysis</div>
        <div class="brand-right">
            <div class="label">Email</div>
            <a href="mailto:support@envirolabsusa.com">{{ p.client_info.email or "support@envirolabsusa.com" }}</a>
        </div>
    </div>

    <div class="report-header">
        <h1>Report for Lab ID: <span class="mono">{{ r.lab_id | default("") }}</span></h1>
        <div class="actions">
            <a class="button" href="javascript:history.back()">Back</a>
            <button class="button primary" onclick="window.print()">Print PDF</button>
        </div>
    </div>

    <h2 class="section-title">Client Information</h2>
    <div class="kv-grid">
        <div class="kv"><div class="k">Client</div><div class="v">{{ p.client_info.client }}</div></div>
        <div class="kv"><div class="k">Phone</div><div class="v">{{ p.client_info.phone }}</div></div>
        <div class="kv"><div class="k">Email</div><div class="v">{{ p.client_info.email }}</div></div>
        <div class="kv"><div class="k">Project Lead</div><div class="v">{{ p.client_info.project_lead }}</div></div>
        <div class="kv span-2"><div class="k">Address</div><div class="v">{{ p.client_info.address }}</div></div>
    </div>

    <h2 class="section-title">Sample Summary</h2>
    <div class="kv-grid">
        <div class="kv"><div class="k">Reported</div><div class="v">{{ p.sample_summary.reported }}</div></div>
        <div class="kv"><div class="k">Received Date</div><div class="v">{{ p.sample_summary.received_date }}</div></div>
        <div class="kv span-2"><div class="k">Sample Name</div><div class="v">{{ p.sample_summary.sample_name }}</div></div>
        <div class="kv"><div class="k">Prepared By</div><div class="v">{{ p.sample_summary.prepared_by }}</div></div>
        <div class="kv"><div class="k">Matrix</div><div class="v">{{ p.sample_summary.matrix }}</div></div>
        <div class="kv"><div class="k">Prepared Date</div><div class="v">{{ p.sample_summary.prepared_date }}</div></div>
        <div class="kv"><div class="k">ASIN (Identifier)</div><div class="v">{{ p.sample_summary.asin }}</div></div>
        <div class="kv"><div class="k">Product Weight (g)</div><div class="v">{{ p.sample_summary.product_weight_g }}</div></div>
        <div class="kv span-2"><div class="k">Qualifiers</div><div class="v">{{ p.sample_summary.qualifiers }}</div></div>
    </div>

    <section class="card" style="margin: 20px 0; padding: 20px;">
        <h2 class="section-title" style="margin-top: 0;">Sample Results</h2>
        {% if r.pdf_url %}
        <table class="table clean">
            <thead>
                <tr>
                    <th>Analyte</th>
                    <th>Result</th>
                    <th>MRL</th>
                    <th>Units</th>
                    <th>Dilution</th>
                    <th>Analyzed</th>
                    <th>Qualifier</th>
                </tr>
            </thead>
            <tbody>
                {% set results = r.pdf_url.split(' | ') %}
                {% for item in results %}
                    {% set parts = item.split(': ') %}
                    {% if parts | length == 2 %}
                    <tr>
                        <td>{{ parts[0] }}</td>
                        <td>{{ parts[1] }}</td>
                        <td>{{ p.sample_results.mrl }}</td>
                        <td>{{ p.sample_results.units }}</td>
                        <td>{{ p.sample_results.dilution }}</td>
                        <td>{{ p.sample_results.analyzed }}</td>
                        <td>{{ p.sample_results.qualifier }}</td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="muted">No detailed analyte results found for this sample.</p>
        {% endif %}
    </section>


    <section class="card" style="margin: 20px 0; padding: 20px;">
        <h2 class="section-title" style="margin-top: 0;">Quality Control Results</h2>

        <h3 style="font-size: 1.1rem; margin: 15px 0 8px;">Method Blank</h3>
        {% if r.acq_datetime %}
        <table class="table clean">
            <thead>
                <tr>
                    <th>Analyte</th>
                    <th>Result</th>
                    <th>MRL</th>
                    <th>Units</th>
                    <th>Dilution</th>
                </tr>
            </thead>
            <tbody>
                {% set mb_results = r.acq_datetime.split(' | ') %}
                {% for item in mb_results %}
                    {# The inner separator is a single pipe (|) #}
                    {% set parts = item.split('|') %}
                    {# Expected fields: Analyte(0), Result(1), MRL(2), Units(3), Dilution(4) #}
                    {% if parts | length >= 5 %}
                    <tr>
                        <td>{{ parts[0] | default("") }}</td> <td>{{ parts[1] | default("") }}</td> <td>{{ parts[2] | default("") }}</td> <td>{{ parts[3] | default("") }}</td> <td>{{ parts[4] | default("") }}</td> </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
             <p class="muted">Method Blank data is not available for this sample.</p>
        {% endif %}


        <h3 style="font-size: 1.1rem; margin: 15px 0 8px;">Matrix Spike</h3>
        {% if r.sheet_name %}
        <table class="table clean">
            <thead>
                <tr>
                    <th>Analyte</th>
                    <th>Result</th>
                    <th>MRL</th>
                    <th>Units</th>
                    <th>Dilution</th>
                    <th>Fortified Level</th>
                    <th>%REC</th>
                    <th>%REC Limits</th>
                </tr>
            </thead>
            <tbody>
                {% set ms1_results = r.sheet_name.split(' | ') %}
                {% for item in ms1_results %}
                    {% set parts = item.split('|') %}
                    {# Expected fields: Analyte(0), Result(1), MRL(2), Units(3), Dilution(4), Fortified Level(5), %REC(6), %REC Limits(7) #}
                    {% if parts | length >= 8 %}
                    <tr>
                        <td>{{ parts[0] | default("") }}</td> <td>{{ parts[1] | default("") }}</td> <td>{{ parts[2] | default("") }}</td> <td>{{ parts[3] | default("") }}</td> <td>{{ parts[4] | default("") }}</td> <td>{{ parts[5] | default("") }}</td> <td>{{ parts[6] | default("") }}</td> <td>{{ parts[7] | default("") }}</td> </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="muted">Matrix Spike data is not available for this sample.</p>
        {% endif %}

        
        <h3 style="font-size: 1.1rem; margin: 15px 0 8px;">Matrix Spike Duplicate</h3>
        <p class="muted" style="margin-bottom: 8px;">Note: This section currently displays the MSD result from the last analyzed analyte only due to database constraints.</p>
        <table class="table clean">
            <thead>
                <tr>
                    <th>Analyte</th>
                    <th>Result</th>
                    <th>Units</th>
                    <th>Dilution</th>
                    <th>%REC</th>
                    <th>%REC Limits</th>
                    <th>%RPD</th>
                    <th>%RPD Limit</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ p.matrix_spike_dup.analyte }}</td>
                    <td>{{ p.matrix_spike_dup.result }}</td>
                    <td>{{ p.matrix_spike_dup.units }}</td>
                    <td>{{ p.matrix_spike_dup.dilution }}</td>
                    <td>{{ p.matrix_spike_dup.pct_rec }}</td>
                    <td>{{ p.matrix_spike_dup.pct_rec_limits }}</td>
                    <td>{{ p.matrix_spike_dup.pct_rpd }}</td>
                    <td>{{ p.matrix_spike_dup.pct_rpd_limit }}</td>
                </tr>
            </tbody>
        </table>
    </section>

    <div class="review-strip">
        <div class="review-item">
            <div class="k">Reviewed by</div>
            <div class="v">&nbsp;</div>
        </div>
        <div class="review-item">
            <div class="k">Signature</div>
            <div class="sig-line"></div>
        </div>
    </div>

    <h2 class="section-title">Definitions and Remarks</h2>
    <ul class="defs">
        <li><strong>%REC</strong> – Percent Recovery</li>
        <li><strong>MRL</strong> – The minimum levels, concentrations, or quantities of a target variable that can be
            reported with a specified degree of confidence. Also known as LOQ.</li>
        <li><strong>ND</strong> – Not detected at or above the MRL (or MDL when reported).</li>
        <li><strong>RPD</strong> – Relative Percent Difference.</li>
        <li><strong>MS1</strong> – MS/MSD recoveries outside acceptance limits due to source sample concentration > 4×
            spike concentration. Surrogate recoveries within acceptance criteria.</li>
        <li>Any remaining sample(s) will be disposed of one month from the final report date unless other arrangements are made in advance.</li>
    </ul>

    <p class="disclaimer">
        <strong>Disclaimer</strong> — The results in this report are provided for informational purposes related to the
        consumer products analysis of BPS, PFAS, and related compounds. Findings are estimated quantities and intended solely
        for the client's use as requested. Results are based on data obtained during the experiment and are subject to method
        limitations. The laboratory assumes no responsibility for interpretation or use of these results beyond their
        analytical scope, nor for decisions taken based on this information. It is the client’s responsibility to ensure
        compliance with all applicable regulatory standards.
    </p>

    <p class="final-note">
        <strong>ENVIRO LABS LLC</strong> • Email:
        <a href="mailto:support@envirolabsusa.com">support@envirolabsusa.com</a>
    </p>
    <p class="footer-address">Address: 18102 Sky Park Cir Suite G, Irvine, CA 92614 &nbsp;|&nbsp; Phone: (949) 892-1915</p>
</section>

{% endblock %}
