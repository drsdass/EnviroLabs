@app.route("/report/<int:report_id>")
def report_detail(report_id):
    u = current_user()
    if not u["username"]:
        return redirect(url_for("home"))

    db = SessionLocal()
    r = db.query(Report).get(report_id)
    db.close()

    if not r:
        flash("Report not found", "error")
        return redirect(url_for("dashboard"))
    if u["role"] == "client" and r.client != u["client_name"]:
        flash("Unauthorized", "error")
        return redirect(url_for("dashboard"))

    # Default payload
    p = {
        "client_info": {
            "client": r.client or "",
            "phone": "",
            "email": "support@envirolabsusa.com",
            "project_lead": "",
            "address": "",
        },
        "sample_summary": {
            "reported": r.resulted_date.isoformat() if r.resulted_date else "",
            "received_date": r.collected_date.isoformat() if r.collected_date else "",
            "sample_name": r.patient_name or r.lab_id or "",
            "prepared_by": "", "matrix": "", "prepared_date": "",
            "qualifiers": "", "asin": "", "product_weight_g": ""
        },
        "sample_results": {
            "analyte": r.test or "", "result": r.result or "", "mrl": "", "units": "",
            "dilution": "", "analyzed": "", "qualifier": ""
        },
        "method_blank":   {"analyte":"", "result":"", "mrl":"", "units":"", "dilution":""},
        "matrix_spike_1": {"analyte":"", "result":"", "mrl":"", "units":"", "dilution":"", "fortified_level":"", "%REC":"", "pct_rec":"", "pct_rec_limits":""},
        "matrix_spike_dup":{"analyte":"", "result":"", "units":"", "dilution":"", "pct_rec":"", "pct_rec_limits":"", "pct_rpd":"", "pct_rpd_limit":""},
        "acq_datetime": "", "sheet_name": ""
    }

    # Overlay with values from the latest Master Upload File
    master = _read_master_row_for_lab(r.lab_id)
    if master:
        if master.get("client"):       p["client_info"]["client"] = master["client"]
        if master.get("phone"):        p["client_info"]["phone"] = master["phone"]
        if master.get("email"):        p["client_info"]["email"] = master["email"]
        if master.get("project_lead"): p["client_info"]["project_lead"] = master["project_lead"]
        if master.get("address"):      p["client_info"]["address"] = master["address"]

    return render_template("report_detail.html", user=u, r=r, p=p)
