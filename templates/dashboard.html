from sqlalchemy import func, and_

@app.route("/dashboard")
def dashboard():
    u = current_user()
    if not u["username"]:
        return redirect(url_for("home"))

    lab_id_q = (request.args.get("lab_id") or "").strip() or None
    start_q = (request.args.get("start") or "").strip()
    end_q   = (request.args.get("end") or "").strip()

    sd = parse_date(start_q) if start_q else None
    ed = parse_date(end_q) if end_q else None

    db = SessionLocal()
    try:
        # Subquery: one canonical id per (lab_id, client)
        subq = (
            db.query(func.min(Report.id).label("id"))
              .group_by(Report.lab_id, Report.client)
        )

        # Base query = canonical report headers only
        q = db.query(Report).filter(Report.id.in_(subq))

        # Optional filters
        if u["role"] == "client":
            q = q.filter(Report.client == u["client_name"])
        if lab_id_q:
            q = q.filter(Report.lab_id == lab_id_q)
        if sd:
            q = q.filter(Report.resulted_date >= sd)
        if ed:
            q = q.filter(Report.resulted_date <= ed)

        # Order (SQLite has no NULLS LAST—do two-pass sort)
        q = q.order_by(Report.resulted_date.is_(None), Report.resulted_date.desc(), Report.id.desc())

        reports = q.limit(500).all()
        return render_template("dashboard.html", user=u, reports=reports)
    except Exception as e:
        # Don’t 500 the whole page—show the error and keep going
        flash(f"Could not load dashboard: {e}", "error")
        return render_template("dashboard.html", user=u, reports=[])
    finally:
        db.close()
