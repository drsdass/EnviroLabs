{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Reports</h2>
    <form method="get" class="grid three" style="margin-bottom:.5rem;">
      <div>
        <label>Lab ID</label>
        <input type="text" name="lab_id" value="{{ request.args.get('lab_id','') }}" placeholder="e.g. 24-00123">
      </div>
      <div>
        <label>Resulted Start</label>
        <input type="date" name="start" value="{{ request.args.get('start','') }}">
      </div>
      <div>
        <label>Resulted End</label>
        <input type="date" name="end" value="{{ request.args.get('end','') }}">
      </div>
      <div>
        <button type="submit">Apply Filters</button>
        <a class="button secondary" href="{{ url_for('dashboard') }}">Clear</a>
      </div>
    </form>
  </div>

  {% if user.role == 'admin' %}
    <div class="card">
      <h3>Upload CSV (Admin)</h3>
      <form method="post" action="{{ url_for('upload_csv') }}" enctype="multipart/form-data" class="grid two">
        <div>
          <label>CSV File</label>
          <input type="file" name="csv_file" accept=".csv,.xlsx" required>
          <div class="checkbox">
            <input id="keep" type="checkbox" name="keep_original" checked>
            <label for="keep" style="margin:0;">Keep original file on server</label>
          </div>
          <p class="footer-note">We parse column names flexibly (Lab ID, Client, Patient, Test, Result, Collected, Resulted, PDF URL).</p>
        </div>
        <div style="align-self:end;">
          <button type="submit">Import</button>
        </div>
      </form>
    </div>
  {% endif %}

  <div class="card table-wrap">
    <table>
      <thead>
      <tr>
        <th>Lab ID</th>
        <th>Client</th>
        <th>Patient</th>
        <th>Test</th>
        <th>Result</th>
        <th>Collected</th>
        <th>Resulted</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      {% for r in reports %}
        <tr>
          <td>{{ r.lab_id }}</td>
          <td>{{ r.client }}</td>
          <td>{{ r.patient_name or '' }}</td>
          <td>{{ r.test or '' }}</td>
          <td>{{ r.result or '' }}</td>
          <td>{{ r.collected_date or '' }}</td>
          <td>{{ r.resulted_date or '' }}</td>
          <td><a class="button small secondary" href="{{ url_for('report_detail', report_id=r.id) }}">View</a></td>
        </tr>
      {% else %}
        <tr><td colspan="8" class="muted">No reports found.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
