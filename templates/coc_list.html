{% extends "base.html" %}
{% block content %}

<section class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
    <div>
      <h1 style="margin:0;">Chain of Custody</h1>
      <p style="margin:6px 0 0 0; opacity:.8;">
        Select one or more samples, then click <b>Receive</b> to time/date stamp the check-in.
      </p>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a class="button" href="{{ url_for('coc_print') }}">Print View</a>
      <a class="button" href="{{ url_for('coc_export_pdf') }}">Download PDF</a>
      {% if user.role == 'admin' %}
        <a class="button" href="{{ url_for('coc_upload') }}">Upload Total Products</a>
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <form method="POST" action="{{ url_for('coc_receive_selected') }}">

    {% if user.role == 'admin' %}
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin-bottom:12px;">
        <div style="min-width:220px;">
          <label><b>Bulk Status</b></label>
          <select name="bulk_status" class="input">
            <option value="Received">Received</option>
            <option value="Pending">Pending</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
            <option value="Hold">Hold</option>
          </select>
        </div>

        <div style="min-width:220px;">
          <label><b>Bulk Location</b></label>
          <select name="bulk_location" class="input">
            <option value="Intake">Intake</option>
            <option value="Freezer">Freezer</option>
            <option value="Refrigerator">Refrigerator</option>
            <option value="Lab">Lab</option>
            <option value="Storage">Storage</option>
          </select>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit" class="button">Receive / Update Selected</button>
          <button type="button" class="button" onclick="toggleAll(true)">Select All</button>
          <button type="button" class="button" onclick="toggleAll(false)">Clear</button>
        </div>
      </div>
    {% else %}
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px;">
        <button type="submit" class="button">Receive Selected</button>
        <button type="button" class="button" onclick="toggleAll(true)">Select All</button>
        <button type="button" class="button" onclick="toggleAll(false)">Clear</button>
        <span style="opacity:.75;">(Clients cannot overwrite an already-received timestamp.)</span>
      </div>
    {% endif %}

    <div style="overflow:auto;">
      <table class="table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="width:42px;">Sel</th>
            <th>SAMPLE I.D. / NAME</th>
            <th>LAB ID#</th>
            <th>ASIN (Identifier)</th>
            <th>SAMPLE TYPE</th>
            <th>SHIPPED BY</th>
            <th>SAMPLE CONDITION</th>
            <th>TEST(S) REQUESTED</th>
            <th>Status</th>
            <th>Received (UTC)</th>
            <th>Received By</th>
            {% if user.role == 'admin' %}
              <th style="width:90px;">Edit</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
            <tr>
              <td style="text-align:center;">
                <input type="checkbox" name="selected_ids" value="{{ r.id }}" class="row-check">
              </td>
              <td>{{ r.sample_name or "" }}</td>
              <td>{{ r.lab_id or "" }}</td>
              <td>{{ r.asin or "" }}</td>
              <td>{{ r.sample_type or r.matrix or "" }}</td>
              <td>{{ r.carrier_name or "" }}</td>
              <td>{{ r.sample_condition or "" }}</td>
              <td>{{ r.anticipated_chemical or "" }}</td>
              <td>{{ r.status or "" }}</td>
              <td>
                {% if r.received_at %}
                  {{ r.received_at.strftime("%Y-%m-%d %H:%M:%S") }}
                {% endif %}
              </td>
              <td>{{ r.received_by or "" }}</td>
              {% if user.role == 'admin' %}
                <td>
                  <a class="button" href="{{ url_for('coc_edit', record_id=r.id) }}">Edit</a>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </form>
</section>

<script>
  function toggleAll(state) {
    document.querySelectorAll(".row-check").forEach(cb => cb.checked = state);
  }
</script>

{% endblock %}
