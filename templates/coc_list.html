{% extends "base.html" %}
{% block content %}

<style>
  /* Make the table easier to scan */
  .coc-table-wrap{
    width:100%;
    overflow-x:auto;
    border-radius:12px;
    -webkit-overflow-scrolling: touch;
  }

  /* Horizontal scrollbar is in the card area (not only at page bottom) */
  .coc-table-wrap::-webkit-scrollbar { height: 10px; }
  .coc-table-wrap::-webkit-scrollbar-thumb { background: rgba(0,0,0,.18); border-radius: 10px; }
  .coc-table-wrap::-webkit-scrollbar-track { background: rgba(0,0,0,.06); border-radius: 10px; }

  .coc-table{
    width:100%;
    border-collapse:collapse;
    font-size:12px;           /* ✅ smaller font */
    line-height:1.25;
    min-width: 1400px;        /* ✅ forces horizontal scroll so columns don't crush */
  }

  .coc-table th{
    white-space:nowrap;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .coc-sample{
    max-width: 420px;         /* ✅ keeps SAMPLE NAME from making table huge */
    white-space: normal;
    word-break: break-word;
  }

  .coc-actions{
    white-space:nowrap;
  }

  /* Smaller buttons for row actions */
  .coc-actions .button{
    padding:6px 10px;
    font-size:12px;
  }

  .filters-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:end;
    margin-top:10px;
  }

  .filters-row .input{
    min-width:220px;
  }

  .pager{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    margin-top:14px;
    flex-wrap:wrap;
  }

  .pill{
    padding:6px 10px;
    border-radius:999px;
    background: rgba(0,0,0,.06);
    font-weight:600;
  }
</style>

<section class="card">
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
    <div>
      <h1 style="margin:0;">Chain of Custody</h1>
      <p style="margin:6px 0 0 0; opacity:.8;">
        Select one or more samples, then click <b>Receive</b> to time/date stamp the check-in.
      </p>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      {% if user.role == 'admin' %}
        <a class="button" href="{{ url_for('coc_upload') }}">Upload Total Products</a>
      {% endif %}
    </div>
  </div>

  <!-- ✅ Search + Per-page controls -->
  <form method="GET" action="{{ url_for('coc_list') }}" class="filters-row">
    <div style="min-width:260px;">
      <label><b>Search Lab ID#</b></label>
      <input class="input" type="text" name="lab_id" value="{{ lab_id_q or '' }}" placeholder="e.g. 260105-B38">
    </div>

    <div style="min-width:220px;">
      <label><b>Show</b></label>
      <select name="per_page" class="input">
        {% for opt in per_page_options %}
          <option value="{{ opt }}" {% if per_page == opt %}selected{% endif %}>
            {{ opt|upper }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button type="submit" class="button">Apply</button>
      <a class="button" href="{{ url_for('coc_list') }}">Reset</a>
    </div>

    <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
      <span class="pill">Total: {{ total }}</span>
      {% if per_page != 'all' %}
        <span class="pill">Page {{ page }} / {{ total_pages }}</span>
      {% endif %}
    </div>
  </form>
</section>

<section class="card">
  <form method="POST" action="{{ url_for('coc_receive_selected') }}">

    {% if user.role == 'admin' %}
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin-bottom:12px;">
        <div style="min-width:220px;">
          <label><b>Bulk Status</b></label>
          <select name="bulk_status" class="input">
            <option value="Received">Received</option>
            <option value="Pending">Pending</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
            <option value="Hold">Hold</option>
          </select>
        </div>

        <div style="min-width:220px;">
          <label><b>Bulk Location</b></label>
          <select name="bulk_location" class="input">
            <option value="Intake">Intake</option>
            <option value="Freezer">Freezer</option>
            <option value="Refrigerator">Refrigerator</option>
            <option value="Lab">Lab</option>
            <option value="Storage">Storage</option>
          </select>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit" class="button">Receive / Update Selected</button>
          <button type="button" class="button" onclick="toggleAll(true)">Select All</button>
          <button type="button" class="button" onclick="toggleAll(false)">Clear</button>
        </div>
      </div>
    {% else %}
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px;">
        <button type="submit" class="button">Receive Selected</button>
        <button type="button" class="button" onclick="toggleAll(true)">Select All</button>
        <button type="button" class="button" onclick="toggleAll(false)">Clear</button>
        <span style="opacity:.75;">(Clients cannot overwrite an already-received timestamp.)</span>
      </div>
    {% endif %}

    <div class="coc-table-wrap">
      <table class="table coc-table">
        <thead>
          <tr>
            <th style="width:42px;">Sel</th>
            <th>Actions</th>
            <th>SAMPLE I.D. / NAME</th>
            <th>LAB ID#</th>
            <th>ASIN (Identifier)</th>
            <th>SAMPLE TYPE</th>
            <th>SHIPPED BY</th>
            <th>SAMPLE CONDITION</th>
            <th>TEST(S) REQUESTED</th>
            <th>Status</th>
            <th>Received (UTC)</th>
            <th>Received By</th>
          </tr>
        </thead>

        <tbody>
          {% if records and records|length > 0 %}
            {% for r in records %}
              <tr>
                <td style="text-align:center;">
                  <input type="checkbox" name="selected_ids" value="{{ r.id }}" class="row-check">
                </td>

                <!-- ✅ Per-record actions (Print/PDF are for INDIVIDUAL COC only) -->
                <td class="coc-actions">
                  <a class="button" href="{{ url_for('coc_print_single', record_id=r.id) }}" target="_blank">Print</a>
                  <a class="button" href="{{ url_for('coc_pdf_single', record_id=r.id) }}" target="_blank">PDF</a>

                  {% if user.role == 'admin' %}
                    <a class="button" href="{{ url_for('coc_edit', record_id=r.id) }}">Edit</a>
                  {% endif %}
                </td>

                <td class="coc-sample">{{ r.sample_name or "" }}</td>
                <td>{{ r.lab_id or "" }}</td>
                <td>{{ r.asin or "" }}</td>
                <td>{{ r.sample_type or r.matrix or "" }}</td>
                <td>{{ r.carrier_name or "" }}</td>
                <td>{{ r.sample_condition or "" }}</td>
                <td>{{ r.anticipated_chemical or "" }}</td>
                <td>{{ r.status or "" }}</td>

                <td>
                  {% if r.received_at %}
                    {{ r.received_at.strftime("%Y-%m-%d %H:%M:%S") }}
                  {% endif %}
                </td>

                <td>{{ r.received_by or "" }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="12" style="opacity:.75;">
                No samples found.
                {% if lab_id_q %}Try clearing the Lab ID search.{% else %}Upload a Total Products file above.{% endif %}
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

  </form>

  <!-- ✅ Pagination controls -->
  {% if per_page != 'all' and total_pages > 1 %}
    <div class="pager">
      {% if page > 1 %}
        <a class="button" href="{{ url_for('coc_list', lab_id=lab_id_q, per_page=per_page, page=page-1) }}">Prev</a>
      {% endif %}

      <span class="pill">Page {{ page }} of {{ total_pages }}</span>

      {% if page < total_pages %}
        <a class="button" href="{{ url_for('coc_list', lab_id=lab_id_q, per_page=per_page, page=page+1) }}">Next</a>
      {% endif %}
    </div>
  {% endif %}

</section>

<script>
  function toggleAll(state) {
    document.querySelectorAll(".row-check").forEach(cb => cb.checked = state);
  }
</script>

{% endblock %}
