{% extends "base.html" %}

{% block content %}
<section class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
    <div>
      <h1 style="margin:0;">Edit Chain of Custody</h1>
      <p style="margin:6px 0 0 0; opacity:.8;">Admin-only edit screen</p>
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a class="button" href="{{ url_for('coc_list') }}">Back</a>
    </div>
  </div>
</section>

<section class="card">
  <h2 style="margin-top:0;">Sample</h2>

  <div style="display:grid; grid-template-columns: 220px 1fr; gap:8px 14px; align-items:start;">
    <div style="opacity:.75;">SAMPLE I.D. / NAME</div><div>{{ record.sample_name or "" }}</div>
    <div style="opacity:.75;">LAB ID#</div><div>{{ record.lab_id or "" }}</div>
    <div style="opacity:.75;">ASIN (Identifier)</div><div>{{ record.asin or "" }}</div>
    <div style="opacity:.75;">SAMPLE TYPE</div><div>{{ record.sample_type or record.matrix or "" }}</div>
    <div style="opacity:.75;">SHIPPED BY</div><div>{{ record.carrier_name or "" }}</div>
    <div style="opacity:.75;">Received (UTC)</div>
    <div>
      {% if record.received_at %}
        {{ record.received_at.strftime("%Y-%m-%d %H:%M:%S") }}
      {% else %}
        —
      {% endif %}
    </div>
    <div style="opacity:.75;">Received By</div><div>{{ record.received_by or "—" }}</div>
  </div>
</section>

<section class="card">
  <h2 style="margin-top:0;">Update</h2>

  <form method="POST" action="{{ url_for('coc_edit', record_id=record.id) }}">
    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:end;">

      <div style="min-width:220px;">
        <label><b>Status</b></label>
        {% set cur = record.status or "Pending" %}
        <select name="status" class="input">
          <option value="Pending" {% if cur=="Pending" %}selected{% endif %}>Pending</option>
          <option value="Received" {% if cur=="Received" %}selected{% endif %}>Received</option>
          <option value="In Progress" {% if cur=="In Progress" %}selected{% endif %}>In Progress</option>
          <option value="Completed" {% if cur=="Completed" %}selected{% endif %}>Completed</option>
          <option value="Hold" {% if cur=="Hold" %}selected{% endif %}>Hold</option>
        </select>
      </div>

      <div style="min-width:220px;">
        <label><b>Location</b></label>
        {% set loc = record.location or "Intake" %}
        <select name="location" class="input">
          <option value="Intake" {% if loc=="Intake" %}selected{% endif %}>Intake</option>
          <option value="Freezer" {% if loc=="Freezer" %}selected{% endif %}>Freezer</option>
          <option value="Refrigerator" {% if loc=="Refrigerator" %}selected{% endif %}>Refrigerator</option>
          <option value="Lab" {% if loc=="Lab" %}selected{% endif %}>Lab</option>
          <option value="Storage" {% if loc=="Storage" %}selected{% endif %}>Storage</option>
        </select>
      </div>

      <div style="min-width:260px;">
        <label><b>SAMPLE CONDITION</b></label>
        <input class="input" type="text" name="sample_condition" value="{{ record.sample_condition or '' }}">
      </div>

      <div style="min-width:320px; flex:1;">
        <label><b>TEST(S) REQUESTED</b></label>
        <input class="input" type="text" name="anticipated_chemical" value="{{ record.anticipated_chemical or '' }}">
      </div>

      <div>
        <button type="submit" class="button">Save</button>
      </div>

    </div>
  </form>
</section>

<section class="card">
  <h2 style="margin-top:0;">Audit History</h2>

  <div style="overflow:auto;">
    <table class="table" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th>Time (UTC)</th>
          <th>User</th>
          <th>Role</th>
          <th>Action</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for h in history %}
          <tr>
            <td>{{ h.at.strftime("%Y-%m-%d %H:%M:%S") if h.at else "" }}</td>
            <td>{{ h.username }}</td>
            <td>{{ h.role }}</td>
            <td>{{ h.action }}</td>
            <td style="white-space:pre-wrap;">{{ h.details }}</td>
          </tr>
        {% endfor %}

        {% if not history %}
          <tr>
            <td colspan="5" style="text-align:center; opacity:.75; padding:18px;">No audit history found for this sample.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
