{% extends "base.html" %}
{% block content %}

<section class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
    <div>
      <h1 style="margin:0;">Edit Chain of Custody</h1>
      <p style="margin:6px 0 0 0; opacity:.8;">
        Lab ID: <b>{{ record.lab_id }}</b>
      </p>
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a class="button" href="{{ url_for('coc_list') }}">Back</a>
    </div>
  </div>
</section>

<section class="card">
  <form method="POST">
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      <div>
        <label><b>Status</b></label>
        <input class="input" name="status" value="{{ record.status or '' }}">
      </div>

      <div>
        <label><b>Location</b></label>
        <input class="input" name="location" value="{{ record.location or '' }}">
      </div>

      <div>
        <label><b>SAMPLE CONDITION</b></label>
        <input class="input" name="sample_condition" value="{{ record.sample_condition or '' }}">
      </div>

      <div style="grid-column: 1 / -1;">
        <label><b>TEST(S) REQUESTED</b></label>
        <input class="input" name="anticipated_chemical" value="{{ record.anticipated_chemical or '' }}">
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="button" type="submit">Save</button>
      <a class="button" href="{{ url_for('coc_list') }}">Cancel</a>
    </div>
  </form>
</section>

<section class="card">
  <h2 style="margin-top:0;">Sample Details</h2>
  <div style="overflow:auto;">
    <table class="table" style="width:100%; border-collapse:collapse;">
      <tbody>
        <tr><th>SAMPLE I.D. / NAME</th><td>{{ record.sample_name or "" }}</td></tr>
        <tr><th>LAB ID#</th><td>{{ record.lab_id or "" }}</td></tr>
        <tr><th>ASIN (Identifier)</th><td>{{ record.asin or "" }}</td></tr>
        <tr><th>SAMPLE TYPE</th><td>{{ record.sample_type or record.matrix or "" }}</td></tr>
        <tr><th>SHIPPED BY</th><td>{{ record.carrier_name or "" }}</td></tr>
        <tr><th>Status</th><td>{{ record.status or "" }}</td></tr>
        <tr><th>Location</th><td>{{ record.location or "" }}</td></tr>
        <tr><th>Received (UTC)</th>
          <td>
            {% if record.received_at %}
              {{ record.received_at.strftime("%Y-%m-%d %H:%M:%S") }}
            {% endif %}
          </td>
        </tr>
        <tr><th>Received By</th><td>{{ record.received_by or "" }}</td></tr>
        <tr><th>Tracking #</th><td>{{ record.tracking_number or "" }}</td></tr>
        <tr><th>Last Intake File</th><td>{{ record.received_via_file or "" }}</td></tr>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2 style="margin-top:0;">Audit History</h2>
  {% if history and history|length > 0 %}
    <div style="overflow:auto;">
      <table class="table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th>Time (UTC)</th>
            <th>User</th>
            <th>Role</th>
            <th>Action</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for h in history %}
            <tr>
              <td>
                {% if h.at %}
                  {{ h.at.strftime("%Y-%m-%d %H:%M:%S") }}
                {% endif %}
              </td>
              <td>{{ h.username }}</td>
              <td>{{ h.role }}</td>
              <td>{{ h.action }}</td>
              <td>{{ h.details }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p style="opacity:.8;">No audit entries yet for this sample.</p>
  {% endif %}
</section>

{% endblock %}
